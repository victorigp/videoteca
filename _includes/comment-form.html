<div id="comment-form-wrapper" class="px-lg-2">
  <h3 class="font-weight-bold">Deja un comentario</h3>
  <form id="comment-form" class="needs-validation" novalidate>
    <!-- Campos de control anti-spam -->
    <input type="hidden" name="honeypot" />
    <input type="hidden" name="ts" value="" />
    <div class="visually-hidden">
      <label for="website">Sitio web</label>
      <input type="text" id="website" name="website" autocomplete="off" tabindex="-1" aria-hidden="true" />
    </div>

    <!-- These hidden fields are necessary for the backend -->
    <input type="hidden" name="repo" value="{{ site.comments.custom.repo }}" />
    <input type="hidden" name="slug" value="{{ page.slug | slugify }}" />
    <input type="hidden" name="url" value="{{ page.url | absolute_url }}" />

    <div class="form-group">
      <label for="comment-name">Nombre <span class="text-danger">*</span></label>
      <input type="text" class="form-control" id="comment-name" name="name" required maxlength="80" />
      <div class="invalid-feedback">El nombre es obligatorio.</div>
    </div>

    <div class="form-group">
      <label for="comment-email">Email</label>
      <input type="email" class="form-control" id="comment-email" name="email" maxlength="254" />
      <small class="form-text text-muted">
        Introduce tu email (opcional) para mostrar un avatar único. Esto ayuda a diferenciarte de otros usuarios con el mismo nombre. Tu email nunca será público.
      </small>
    </div>

    <div class="form-group">
      <label for="comment-message">Mensaje <span class="text-danger">*</span> <small class="text-muted">(<span id="msg-remaining">4000</span>/4000)</small></label>
      <textarea class="form-control" id="comment-message" name="message" rows="5" required maxlength="4000"></textarea>
      <div class="invalid-feedback">El mensaje no puede estar vacío.</div>
    </div>

    <div class="form-group">
      <button type="submit" id="comment-submit-btn" class="btn btn-primary">
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        Enviar Comentario
      </button>
    </div>
  </form>
  <div id="comment-form-alert" class="alert mt-3 d-none" role="alert" aria-live="polite"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("comment-form");
    const submitBtn = document.getElementById("comment-submit-btn");
    const alertContainer = document.getElementById("comment-form-alert");
    const spinner = submitBtn.querySelector(".spinner-border");

    // Marca de tiempo anti-bot (time-trap)
    const tsField = form.querySelector('input[name="ts"]');
    tsField.value = Date.now().toString();

    // Contadores y hard limits
    const nameInput = document.getElementById('comment-name');
    const emailInput = document.getElementById('comment-email');
    const msgInput = document.getElementById('comment-message');
    const remaining = document.getElementById('msg-remaining');

    const hardLimit = (el) => {
      el.addEventListener('input', () => {
        const max = el.maxLength;
        if (el.value.length > max) el.value = el.value.slice(0, max);
        if (el === msgInput && remaining) remaining.textContent = String(max - el.value.length);
      });
      el.addEventListener('paste', (e) => {
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const max = el.maxLength;
        const start = el.selectionStart;
        const end = el.selectionEnd;
        const current = el.value;
        const next = current.slice(0, start) + paste + current.slice(end);
        if (next.length > max) {
          e.preventDefault();
          const slice = paste.slice(0, max - (current.length - (end - start)));
          document.execCommand('insertText', false, slice);
        }
      });
    };
    [nameInput, emailInput, msgInput].forEach(hardLimit);

    form.addEventListener("submit", function (event) {
      event.preventDefault();
      event.stopPropagation();

      if (form.checkValidity() === false) {
        form.classList.add("was-validated");
        return;
      }

      submitBtn.disabled = true;
      spinner.classList.remove("d-none");
      alertContainer.classList.add("d-none");

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      fetch("{{ site.comments.custom.endpoint }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
        },
        body: JSON.stringify(data),
      })
      .then(async (response) => {
        const body = await response.json().catch(() => ({ message: "" }));
        return { status: response.status, body };
      })
      .then(({ status, body }) => {
        if (status === 201 && body && body.ok) {
          // Append optimista
          try {
            const list = document.querySelector('.comment-list');
            if (list) {
              const div = document.createElement('div');
              div.className = 'comment';
              div.id = `comment-${body.id}`;
              const emailHash = body.emailHash || '';
              const avatar = emailHash
                ? `https://www.gravatar.com/avatar/${emailHash}?s=80&d=identicon`
                : `https://www.gravatar.com/avatar/?s=80&d=identicon`;
              const safeName = (data.name || '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
              const safeMsg = (data.message || '')
                .replace(/\r\n/g, "\n").replace(/\r/g, "\n")
                .replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))
                .replace(/\n/g, '<br>');
              div.innerHTML = `
                <div class="comment-avatar">
                  <img src="${avatar}" alt="${safeName} avatar">
                </div>
                <div class="comment-content">
                  <div class="comment-header">
                    <span class="comment-author font-weight-bold">${safeName}</span>
                    <span class="comment-date text-muted">justo ahora</span>
                  </div>
                  <div class="comment-body">${safeMsg}</div>
                </div>`;
              list.appendChild(div);
            }
          } catch {}

          form.reset();
          if (remaining) remaining.textContent = '4000';
          form.classList.remove("was-validated");
          showAlert("¡Gracias por tu comentario! Puede tardar unos segundos en aparecer para todos.", "alert-success");
        } else {
          showAlert(body && body.message ? body.message : "No se pudo enviar el comentario.", "alert-danger");
        }
      })
      .catch(error => {
        console.error("Error submitting comment:", error);
        showAlert("Ha ocurrido un error al enviar tu comentario. Por favor, inténtalo de nuevo.", "alert-danger");
      })
      .finally(() => {
        submitBtn.disabled = false;
        spinner.classList.add("d-none");
        alertContainer.focus?.();
      });
    });

    function showAlert(message, type) {
      alertContainer.textContent = message;
      alertContainer.className = `alert ${type} mt-3`;
      alertContainer.classList.remove("d-none");
    }
  });
</script>
