{% assign slug_key = page.slug | slugify %}
{% assign slug_comments_hash = site.data.comments[slug_key] %}
{% if slug_comments_hash and slug_comments_hash.size > 0 %}
  {% assign comments_array = "" | split: "" %}
  {% for item in slug_comments_hash %}
    {% assign comments_array = comments_array | push: item[1] %}
  {% endfor %}
  {% assign comments = comments_array | sort: 'date' %}
{% else %}
  {% assign comments = "" | split: "" %}
{% endif %}

<!-- DEBUGGING BLOCK START -->
<div style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; margin: 20px 0; border-radius: 5px; color: #856404;">
  <h4 style="color: #856404; margin-top: 0;">[DEBUG] Inspección de Comentarios</h4>
  <hr>
  <p><strong>Slug de la página actual:</strong> <code>{{ page.slug }}</code></p>
  <p><strong>Slug normalizado (clave usada):</strong> <code>{{ slug_key }}</code></p>

  <p><strong>Contenido de <code>site.data.comments</code> (todos los comentarios cargados):</strong></p>
  <pre style="white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border-radius: 3px;">{{ site.data.comments | inspect }}</pre>

  <p><strong>Resultado de la búsqueda (variable <code>slug_comments_hash</code>):</strong></p>
  <pre style="white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border-radius: 3px;">{{ slug_comments_hash | inspect }}</pre>

  <p><strong>Array de comentarios antes de ordenar (variable <code>comments_array</code>):</strong></p>
  <pre style="white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border-radius: 3px;">{{ comments_array | inspect }}</pre>

  <p><strong>Array final ordenado (variable <code>comments</code>):</strong></p>
  <pre style="white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border-radius: 3px;">{{ comments | inspect }}</pre>
</div>
<!-- DEBUGGING BLOCK END -->

<div id="comments" class="px-lg-2">
  <h3 class="font-weight-bold">{{ comments.size }} Comentarios</h3>

  {% if comments.size > 0 %}
  <div class="comment-list">
    {% for comment in comments %}
    <div class="comment" id="comment-{{ comment._id }}">
      <div class="comment-avatar">
        {% if comment.email %}
        <img src="https://www.gravatar.com/avatar/{{ comment.email }}?s=80&d=identicon" alt="{{ comment.name }} avatar">
        {% else %}
        <img src="https://www.gravatar.com/avatar/?s=80&d=identicon" alt="Default avatar">
        {% endif %}
      </div>
      <div class="comment-content">
        <div class="comment-header">
          <span class="comment-author font-weight-bold">{{ comment.name }}</span>
          <span class="comment-date text-muted">
            {{ comment.date | date: "%-d de %B de %Y a las %H:%M" }}
          </span>
        </div>
        <div class="comment-body">
          {{ comment.message | markdownify | strip_html }}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p>Todavía no hay comentarios. ¡Sé el primero en comentar!</p>
  {% endif %}
</div>
