<!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode'; // Clave para almacenar la preferencia en localStorage
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      if (this.hasMode) {
        this.applyMode(this.mode);
      } else {
        // Si no hay preferencia almacenada, usa el modo predeterminado del sistema
        this.applyMode(this.isSysDarkPrefer ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE);
      }

      this.sysDarkPrefers.addEventListener('change', () => {
        if (!this.hasMode) {
          this.applyMode(this.isSysDarkPrefer ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE);
        }
      });
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get mode() {
      return localStorage.getItem(ModeToggle.MODE_KEY); // Leer preferencia desde localStorage
    }

    get hasMode() {
      return this.mode != null;
    }

    applyMode(mode) {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, mode);
    }

    setMode(mode) {
      localStorage.setItem(ModeToggle.MODE_KEY, mode); // Guardar preferencia en localStorage
      this.applyMode(mode);
    }

    clearMode() {
      localStorage.removeItem(ModeToggle.MODE_KEY); // Eliminar preferencia del usuario
      this.applyMode(this.isSysDarkPrefer ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE);
    }

    toggleMode() {
      if (this.mode === ModeToggle.DARK_MODE) {
        this.setMode(ModeToggle.LIGHT_MODE);
      } else {
        this.setMode(ModeToggle.DARK_MODE);
      }
    }
  }

  const modeToggle = new ModeToggle();

  // Binding robusto del botón (DOM y navegaciones PJAX)
  function bindToggleButton() {
    try {
      var btn = document.getElementById(ModeToggle.ID);
      if (!btn) return;
      if (!btn.dataset.bound) {
        btn.addEventListener('click', function(){ modeToggle.toggleMode(); });
        btn.dataset.bound = '1';
      }
    } catch(e) {}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindToggleButton);
  } else {
    bindToggleButton();
  }

  // Asegurar que el modo y el binding se apliquen tras navegación PJAX
  document.addEventListener('pjax:success', () => {
    if (modeToggle.hasMode) {
      modeToggle.applyMode(modeToggle.mode);
    }
    bindToggleButton();
  });
  document.addEventListener('pjax:complete', () => {
    if (modeToggle.hasMode) {
      modeToggle.applyMode(modeToggle.mode);
    }
    bindToggleButton();
  });
</script>
